<app-nav></app-nav>
<div class="content">
  <app-header headerTitle="Mail Management"></app-header>
  <div class="workspace">
    <mat-card>
      <mat-card-header>
        <h2>{{create ? 'New Mail' : "Mails"}}</h2>
        <span class="spacer"></span>
        <mat-button-toggle-group *ngIf="!create" [(value)]="mailBox">
          <mat-button-toggle value="inbox" (click)="getMails(true)">Inbox</mat-button-toggle>
          <mat-button-toggle value="sent" (click)="getMails(false)">Sent Mail</mat-button-toggle>
        </mat-button-toggle-group>
        <mat-chip-listbox>
          <mat-chip [ngStyle]="{'background-color':create ? '#3f51b5' : 'lightgrey','transition':'150ms ease-out'}"
                    (click)="createToggle()">
            <mat-icon [ngStyle]="{'color':create ? 'white' : 'black'}">post_add</mat-icon>
          </mat-chip>
          <mat-chip *ngIf="!create"
                    [ngStyle]="{'background-color':delete ? '#3f51b5' : 'lightgrey','transition':'150ms ease-out'}"
                    (click)="deleteToggle()">
            <mat-icon [ngStyle]="{'color':delete ? 'white' : 'black'}">delete</mat-icon>
          </mat-chip>
        </mat-chip-listbox>
      </mat-card-header>
      <mat-card-content *ngIf="!create" class="mail-box">
        <div *ngIf="mailBox=='inbox'">
          <mat-accordion>
            <mat-expansion-panel *ngFor="let inboxmail of inboxmails"
                                 (opened)="inboxmail.isRead?null:updateAsRead(inboxmail.id)">
              <mat-expansion-panel-header [collapsedHeight]="'70px'" [expandedHeight]="'70px'"
                                          [ngStyle]="{'font-weight': !inboxmail.isRead ? 'bold' : ''}">
                <mat-panel-title class="grid">
                  <span>{{inboxmail.sender?.name}}&nbsp;<span class="sub-header">({{inboxmail.sender?.role}})</span></span>
                  <span>{{inboxmail.subject}}</span>
                </mat-panel-title>
                <mat-panel-description>

                  {{inboxmail.date | date:'dd/MM/yyyy'}}
                  <br>
                  {{inboxmail.date | date: 'HH:mm'}}
                  <mat-checkbox *ngIf="delete" (change)="toggleDeleteItems(inboxmail)"></mat-checkbox>
                </mat-panel-description>
              </mat-expansion-panel-header>
              <p>
                {{inboxmail.content}}
              </p>
              <div class="attachment-list">
                <a *ngFor="let file of inboxmail.attachments" [href]="file.downloadUrl">{{file.name}} ({{file.size}}
                  )</a>
              </div>
              <button mat-icon-button (click)="reply(inboxmail)">
                <mat-icon>
                  reply
                </mat-icon>
              </button>
            </mat-expansion-panel>
          </mat-accordion>
        </div>
        <div *ngIf="mailBox=='sent'">
          <div class="sentbox">
            <mat-accordion>
              <mat-expansion-panel *ngFor="let sentboxmail of sentboxmails">
                <mat-expansion-panel-header [collapsedHeight]="'70px'" [expandedHeight]="'70px'">
                  <mat-panel-title class="grid">
                    <span>{{sentboxmail.receiver?.name}}&nbsp;<span class="sub-header">({{sentboxmail.receiver?.role}})</span></span>
                    <span>{{sentboxmail.subject}}</span>
                  </mat-panel-title>
                  <mat-panel-description>
                    {{sentboxmail.date | date: 'dd/MM/yyyy'}}
                    <br>
                    {{sentboxmail.date | date: 'HH:mm'}}
                    <mat-checkbox *ngIf="delete" (change)="toggleDeleteItems(sentboxmail)"></mat-checkbox>
                  </mat-panel-description>
                </mat-expansion-panel-header>
                <p>
                  {{sentboxmail.content}}
                </p>
                <div class="attachment-list">
                  <a *ngFor="let file of sentboxmail.attachments" [href]="file.downloadUrl">{{file.name}} ({{file.size}}
                    )</a>
                </div>
              </mat-expansion-panel>
            </mat-accordion>
          </div>
        </div>
      </mat-card-content>
      <mat-card-actions align="end" *ngIf="delete">
        <button mat-raised-button (click)="deleteMails(); deleteToggle()">Delete</button>
        <button mat-raised-button (click)="deleteToggle()">Discard</button>
      </mat-card-actions>

      <mat-card-content *ngIf="create" class="new-mail">
        <form class="left" #newMail="ngForm" (ngSubmit)="createMail(newMail); createToggle()" id="newMail">
          <mat-form-field appearance="outline">
            <mat-label>Category</mat-label>
            <mat-select [(value)]="selectedType" (valueChange)="getUsersByTypeOnRole()" required>
              <mat-option *ngFor="let type of userTypes" [value]="type.toLowerCase()">{{type}}</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field *ngIf="selectedType=='student' || selectedType=='parent'" appearance="outline">
            <mat-label>Class</mat-label>
            <mat-select (valueChange)="getUsersByTypeOnRole()" [(value)]="selectedCls">
              <mat-option *ngFor="let cls of classes" [value]="cls.id">{{cls.name}}</mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field *ngIf="userRole=='zonal' && selectedType=='teacher'" appearance="outline">
            <mat-label>School</mat-label>
            <mat-select [(value)]="selectedScl" (valueChange)="getUsersByTypeOnRole()">
              <mat-option *ngFor="let scl of schools" [value]="scl.id">{{scl.name}}</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Recipient</mat-label>
            <mat-select multiple [disabled]="users.length==0" name="recipients" [(ngModel)]="recepientIDs" required>
              <mat-option *ngFor="let user of users" [value]="user.id">{{user.name}}</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Subject</mat-label>
            <input matInput placeholder="" name="subject" [(ngModel)]="subject" required>
          </mat-form-field>

          <mat-form-field appearance="outline" class="mailbody">
            <mat-label>Content</mat-label>
            <textarea matInput placeholder="" ngModel name="content"></textarea>
          </mat-form-field>
        </form>

        <div class="right">
          <div class="att">
            <ngx-file-drop [multiple]="true" dropZoneLabel="Drop files here" (onFileDrop)="dropped($event)"
                           (onFileOver)="fileOver($event)" (onFileLeave)="fileLeave($event)">
              <ng-template ngx-file-drop-content-tmp let-openFileSelector="openFileSelector">
                <button type="button" (click)="openFileSelector()">Browse Files</button>
              </ng-template>
            </ngx-file-drop>
            <br><br>

            <div *ngFor="let attachment of attachments;" class="attachment-list">
              <a download [href]="attachment.downloadUrl">
                {{attachment.name}}
                ({{attachment.size}})
              </a>
              <mat-icon (click)="deleteAttachment(attachment)">delete</mat-icon>
            </div>
          </div>
        </div>

      </mat-card-content>
      <mat-card-actions align="end" *ngIf="create">
        <div id="send">
          <button mat-raised-button type="submit" form="newMail" [disabled]="mailForm?.invalid">Send</button>
          <span></span>
          <button mat-raised-button (click)="deleteAllAttachments();createToggle()">Discard</button>
        </div>
      </mat-card-actions>
    </mat-card>
  </div>
</div>
